---
interface Props {
  type: 'chart' | 'tokens' | 'density';
}

const { type } = Astro.props;
---

<div class="rot-visual-container my-6 sm:my-8 not-prose">
  {type === 'chart' && (
    <div class="info-card border-t-4 border-rose-500 shadow-lg sm:shadow-xl dark:bg-slate-800/50 bg-white p-4 sm:p-6 rounded-xl sm:rounded-2xl border dark:border-slate-700 border-slate-200">
      <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-end mb-6 sm:mb-8">
        <div>
          <h2 class="text-xl sm:text-2xl font-bold dark:text-white text-slate-800 mb-1 sm:mb-2">Performance Degradation Curve</h2>
          <p class="text-sm dark:text-slate-400 text-slate-500">
            Theoretical "Uniform Processing" vs Observed Reality.
          </p>
        </div>
        <div class="text-left sm:text-right space-y-1">
          <div class="text-[10px] font-black text-teal-500 mb-1 uppercase tracking-wider flex items-center justify-end gap-2">
            Ideal Assumption <span class="w-3 h-0.5 bg-teal-500 border-b border-dashed"></span>
          </div>
          <div class="text-[10px] font-black text-rose-500 uppercase tracking-wider flex items-center justify-end gap-2">
            Context Rot (Reality) <span class="w-3 h-0.5 bg-rose-500"></span>
          </div>
        </div>
      </div>

      <div class="h-[200px] sm:h-[250px] md:h-[300px] relative">
        <canvas id="rotChart"></canvas>
      </div>
    </div>
  )}

  {type === 'tokens' && (
    <div class="grid grid-cols-1 gap-4 sm:gap-8 lg:grid-cols-2">
      <div class="info-card border-t-4 border-teal-500 dark:bg-slate-800/50 bg-white p-4 sm:p-6 rounded-xl sm:rounded-2xl border dark:border-slate-700 border-slate-200">
        <h3 class="font-bold text-lg sm:text-xl text-teal-500 mb-3 sm:mb-4">The Assumption</h3>
        <p class="dark:text-slate-300 text-slate-600 mb-6 text-sm leading-relaxed">
          Engineers assume LLMs process context uniformly, paying equal attention to every token.
        </p>
        
        <div class="dark:bg-slate-900 bg-slate-50 p-3 sm:p-4 rounded-lg border dark:border-slate-700 border-slate-200">
          <div class="text-[10px] font-bold text-slate-400 mb-3 uppercase tracking-widest">Uniform Attention</div>
          <div class="flex flex-wrap gap-1 sm:gap-1.5 opacity-80">
            {Array.from({ length: 40 }).map(() => (
              <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 bg-teal-400 rounded-sm"></div>
            ))}
          </div>
          <div class="text-[10px] text-teal-500 mt-3 font-mono font-bold">100% RECALL ACCURACY</div>
        </div>
      </div>

      <div class="info-card border-t-4 border-rose-500 dark:bg-slate-800/50 bg-white p-4 sm:p-6 rounded-xl sm:rounded-2xl border dark:border-slate-700 border-slate-200">
        <h3 class="font-bold text-lg sm:text-xl text-rose-500 mb-3 sm:mb-4">The Reality (Rot)</h3>
        <p class="dark:text-slate-300 text-slate-600 mb-6 text-sm leading-relaxed">
          Information in the middle is often ignored as the "Haystack" grows.
        </p>

        <div class="dark:bg-slate-900 bg-slate-50 p-3 sm:p-4 rounded-lg border dark:border-slate-700 border-slate-200">
          <div class="text-[10px] font-bold text-slate-400 mb-3 uppercase tracking-widest">Effective Recall</div>
          <div class="flex flex-wrap gap-1 sm:gap-1.5 opacity-80">
            {Array.from({ length: 8 }).map(() => <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 bg-teal-400 rounded-sm"></div>)}
            {Array.from({ length: 24 }).map((_, i) => (
              <div class="token-rotten w-2 h-2 sm:w-2.5 sm:h-2.5 bg-rose-400 rounded-sm" style={`animation-delay: ${i * 0.1}s`}></div>
            ))}
            {Array.from({ length: 8 }).map(() => <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 bg-teal-400 rounded-sm"></div>)}
          </div>
          <div class="text-[10px] text-rose-500 mt-3 font-mono font-bold">~40-60% DECAY ZONE</div>
        </div>
      </div>
    </div>
  )}

  {type === 'density' && (
    <div class="dark:bg-slate-800/30 bg-slate-50 border dark:border-slate-700 border-slate-200 rounded-xl sm:rounded-2xl p-4 sm:p-8 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-500 rounded-full mix-blend-overlay filter blur-3xl opacity-5"></div>
      
      <div class="relative z-10 flex flex-col gap-6 sm:gap-10 lg:flex-row lg:items-center">
        <div class="flex-1">
          <h2 class="text-xl sm:text-2xl font-bold dark:text-white text-slate-800 mb-3 sm:mb-4">The Antidote: High-Density Context</h2>
          <p class="dark:text-slate-300 text-slate-600 leading-relaxed mb-6">
            Continuum Flow architecture resets the decay curve by compressing a massive, "rotting" haystack into a high-density state diamond.
          </p>
          <ul class="space-y-3">
             <li class="flex items-center gap-3">
                <span class="text-cyan-500 font-bold">✓</span>
                <span class="dark:text-slate-200 text-slate-700 text-sm">Resets "Lost in the Middle" bias</span>
            </li>
            <li class="flex items-center gap-3">
                <span class="text-cyan-500 font-bold">✓</span>
                <span class="dark:text-slate-200 text-slate-700 text-sm">Maintains 100% recall via recursive anchors</span>
            </li>
          </ul>
        </div>
        
        <div class="w-full lg:w-[280px] dark:bg-slate-900 bg-white p-4 sm:p-6 rounded-xl sm:rounded-2xl border dark:border-slate-700 border-slate-200 shadow-sm text-center">
          <div class="text-[10px] text-slate-400 uppercase font-black mb-6 tracking-widest">Density Strategy</div>
          
          <div class="flex items-center justify-center gap-6">
            <div class="w-16 h-28 border-2 border-dashed border-rose-500/30 rounded-lg bg-rose-500/5 flex items-center justify-center relative overflow-hidden">
              <span class="text-[10px] font-black text-rose-400 z-10">100k<br/>RAW</span>
              <div class="absolute inset-0 bg-gradient-to-b from-transparent via-rose-500/10 to-rose-900/40"></div>
            </div>
            
            <div class="text-slate-300 dark:text-slate-700 text-2xl font-light">➔</div>
            
            <div class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl shadow-lg flex items-center justify-center transform rotate-45 border-2 border-white/20">
              <span class="text-[10px] font-black text-white -rotate-45">2k<br/>DENSE</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  @keyframes rot-fade {
    0% { background-color: #fb7185; opacity: 1; transform: scale(1); }
    50% { background-color: #f43f5e; opacity: 0.7; }
    100% { background-color: #94a3b8; opacity: 0.3; transform: scale(0.9); }
  }
  .token-rotten {
    animation: rot-fade 3s infinite alternate;
  }
</style>

{type === 'chart' && (
<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script is:inline>
  function initChart() {
    const canvas = document.getElementById('rotChart');
    if (!canvas) return;
    
    // Check if dark mode
    const isDark = document.documentElement.classList.contains('dark');
    const color = isDark ? '#94a3b8' : '#64748b';
    const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

    new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: ['1k', '5k', '10k', '20k', '50k', '100k'],
        datasets: [
          {
            label: 'Assumption',
            data: [100, 100, 100, 100, 100, 100],
            borderColor: '#14b8a6',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            tension: 0
          },
          {
            label: 'Reality',
            data: [99, 92, 85, 70, 55, 40],
            borderColor: '#f43f5e',
            backgroundColor: 'rgba(244, 63, 94, 0.05)',
            fill: true,
            borderWidth: 3,
            pointBackgroundColor: '#f43f5e',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            grid: { color: gridColor },
            ticks: { color: color, font: { size: 10 } }
          },
          y: { 
            min: 0, max: 105, 
            grid: { color: gridColor },
            ticks: { color: color, font: { size: 10 } }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.9)',
            padding: 12,
            cornerRadius: 8,
          }
        },
        animation: {
            duration: 2500,
            easing: 'easeInOutQuart'
        }
      }
    });
  }

  // Initial load
  initChart();
  
  // Re-init on theme change if needed (DocLayout handles theme toggle)
  document.addEventListener('astro:after-swap', initChart);
</script>
)}
