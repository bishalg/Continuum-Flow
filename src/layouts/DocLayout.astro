---
import "../styles/global.css";
import { SITE, SIDEBAR } from "../config";
import MobileNav from "../components/layout/MobileNav.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import DocFooter from "../components/layout/DocFooter.astro";

const { frontmatter } = Astro.props;
const title = frontmatter?.title || SITE.title;
// Base path for GH pages
const base = import.meta.env.BASE_URL;

const normalize = (p: string) => {
  // Remove leading/trailing slashes and index.html
  return p
    .replace(/\/$/, "")
    .replace(/^\//, "")
    .replace(/\/index\.html$/, "");
};

const currentPathNormalized = normalize(Astro.url.pathname);

const isLinkActive = (link: string | undefined) => {
  if (!link) return false;
  const itemPath = base.replace(/\/$/, "") + "/" + link.replace(/^\//, "");
  return normalize(itemPath) === currentPathNormalized;
};

// Flatten sidebar for pagination
const flatSidebar = SIDEBAR.filter((item) => !item.header);
const currentIndex = flatSidebar.findIndex((item) => isLinkActive(item.link));
const prev = currentIndex > 0 ? flatSidebar[currentIndex - 1] : null;
const next =
  currentIndex < flatSidebar.length - 1 ? flatSidebar[currentIndex + 1] : null;

// Resolve GitHub Edit URL
const githubBase =
  "https://github.com/bishalg/Continuum-Flow/blob/main/src/pages";
let editUrl = "";
if (frontmatter?.file) {
  // MDX files pass absolute path in frontmatter.file
  const relativePath = frontmatter.file.split("/src/pages/")[1];
  editUrl = `${githubBase}/${relativePath}`;
} else {
  // Fallback for .astro pages
  const subPath =
    currentIndex >= 0
      ? flatSidebar[currentIndex]?.link?.replace(/^\//, "") || ""
      : "";
  const fileName = subPath === "" ? "index" : subPath;
  const astroPages = [
    "cost-estimator",
    "differential-state-management",
    "narrative-compression",
    "orchestrator-architecture",
    "tech-visual",
  ];
  const ext = astroPages.includes(fileName) ? "astro" : "mdx";
  editUrl = `${githubBase}/${fileName}.${ext}`;
}

// Resolve PDF URL
const pdfUrl =
  currentIndex >= 0
    ? `${base.replace(/\/$/, "")}/chapters/chap_${currentIndex + 1}_${flatSidebar[currentIndex]?.text.replace(/\s+/g, "_")}.pdf`
    : null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/x-icon" href={`${base}favicon.ico`} />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
      rel="stylesheet"
    />
    <title>{title} | {SITE.title}</title>
    <script is:inline>
      // Inlined for fast load and theme persistence
      const theme = (() => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      })();

      if (theme === "light") {
        document.documentElement.classList.remove("dark");
      } else {
        document.documentElement.classList.add("dark");
      }
      window.localStorage.setItem("theme", theme);
    </script>
  </head>
  <body class="bg-main text-main">
    <MobileNav base={base} />

    <div class="flex max-w-[1600px] mx-auto min-h-screen relative">
      <Sidebar base={base} currentPathNormalized={currentPathNormalized} />

      <!-- Mobile Overlay -->
      <div
        id="overlay"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden lg:hidden print:hidden"
      >
      </div>

      <!-- Main Content -->
      <main class="flex-1 min-w-0 p-6 lg:p-12">
        <div class="max-w-4xl mx-auto">
          {
            frontmatter?.hero && (
              <div class="mb-16 print:mb-8">
                <h1 class="text-5xl lg:text-7xl font-extrabold tracking-tight mb-6 bg-clip-text text-transparent bg-gradient-to-br from-slate-900 to-slate-500 dark:from-white dark:to-slate-400 print:text-black print:bg-none">
                  {frontmatter.title}
                </h1>
                <p class="text-xl text-slate-500 dark:text-slate-400 leading-relaxed max-w-3xl print:text-slate-700">
                  {frontmatter.description}
                </p>
                <div class="h-px bg-gradient-to-r from-cyan-500/50 to-transparent w-full mt-12 print:hidden" />
              </div>
            )
          }

          <article class="prose dark:prose-invert">
            <slot />
          </article>

          <DocFooter
            prev={prev}
            next={next}
            editUrl={editUrl}
            pdfUrl={pdfUrl}
            base={base}
          />
        </div>
      </main>
    </div>

    <script is:inline>
      {
        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const themeToggle = document.getElementById("theme-toggle");
        const themeToggleMobile = document.getElementById(
          "theme-toggle-mobile",
        );

        // Mobile Menu Overlay Logic (Shared between MobileNav and Sidebar)
        menuToggle?.addEventListener("click", () => {
          sidebar?.classList.remove("-translate-x-full");
          overlay?.classList.remove("hidden");
        });

        overlay?.addEventListener("click", () => {
          sidebar?.classList.add("-translate-x-full");
          overlay?.classList.add("hidden");
        });

        // Theme Toggle Orchestration
        const handleThemeToggle = () => {
          const element = document.documentElement;
          element.classList.toggle("dark");
          const isDark = element.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
        };

        themeToggle?.addEventListener("click", handleThemeToggle);
        themeToggleMobile?.addEventListener("click", handleThemeToggle);

        // Global Scroll Observer
        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0.1,
        };

        const observer = new IntersectionObserver((entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        }, observerOptions);

        function setupObserver() {
          const elements = document.querySelectorAll(".animate-on-scroll");
          elements.forEach((el) => observer.observe(el));
        }

        setupObserver();
        // Re-run on Astro page swaps
        document.addEventListener("astro:after-swap", setupObserver);
      }
    </script>

    <style is:global>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }

      @media print {
        /* Force hide nav elements */
        nav,
        aside,
        #overlay,
        .print\:hidden {
          display: none !important;
        }

        /* Ensure text is readable */
        p,
        span,
        div {
          color: black !important;
          text-shadow: none !important;
        }

        /* Hide Next/Prev Buttons explicitly if class check fails */
        a[href*="previous"],
        a[href*="next"],
        .group.flex.flex-col.gap-1 {
          display: none !important;
        }
      }

      /* Global Scroll Animation Utilities */
      .animate-on-scroll {
        opacity: 0;
        transform: translateY(20px);
        transition:
          opacity 0.6s ease-out,
          transform 0.6s ease-out;
        will-change: opacity, transform;
      }
      .animate-on-scroll.is-visible {
        opacity: 1;
        transform: translateY(0);
      }
      .delay-100 {
        transition-delay: 0.1s;
      }
      .delay-200 {
        transition-delay: 0.2s;
      }
      .delay-300 {
        transition-delay: 0.3s;
      }
    </style>
  </body>
</html>
