---
import '../styles/global.css';
import { SITE, SIDEBAR } from '../config';

const { frontmatter } = Astro.props;
const currentPath = Astro.url.pathname.replace(/\/$/, "");
const title = frontmatter?.title || SITE.title;

// Base path for GH pages
const base = import.meta.env.BASE_URL;

// Flatten sidebar for pagination
const flatSidebar = SIDEBAR.filter(item => !item.header);
const currentIndex = flatSidebar.findIndex(item => {
    const itemPath = base.replace(/\/$/, '') + '/' + item.link.replace(/^\//, '');
    const normalize = (p) => p.replace(/\/$/, '').replace(/\/index\.html$/, '');
    return normalize(itemPath) === normalize(currentPath);
});
const prev = currentIndex > 0 ? flatSidebar[currentIndex - 1] : null;
const next = currentIndex < flatSidebar.length - 1 ? flatSidebar[currentIndex + 1] : null;
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/x-icon" href={`${base}favicon.ico`} />
		<meta name="generator" content={Astro.generator} />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
		<title>{title} | {SITE.title}</title>
		<script is:inline>
			// Inlined for fast load and theme persistence
			const theme = (() => {
				if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
					return localStorage.getItem('theme');
				}
				return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
			})();
		
			if (theme === 'light') {
				document.documentElement.classList.remove('dark');
			} else {
				document.documentElement.classList.add('dark');
			}
			window.localStorage.setItem('theme', theme);
		</script>
	</head>
	<body class="bg-main text-main">
		<!-- Top Nav (Mobile) -->
		<nav class="md:hidden glass-nav p-4 flex items-center justify-between">
			<a href={base} class="font-bold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-purple-500">Context-Snoopiest</a>
			<div class="flex items-center gap-4">
				<button id="theme-toggle-mobile" class="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10" aria-label="Toggle theme">
					<svg class="w-5 h-5 dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4.243 1.757a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-1.757 4.243a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.243-1.757a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm1.757-4.243a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 5a5 5 0 100 10 5 5 0 000-10z"></path></svg>
					<svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
				</button>
				<button id="menu-toggle" class="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
				</button>
			</div>
		</nav>

		<div class="flex max-w-[1600px] mx-auto min-h-screen relative">
			<!-- Sidebar -->
			<aside id="sidebar" class="fixed inset-y-0 left-0 w-72 glass-panel border-r transform -translate-x-full lg:translate-x-0 transition-all duration-300 z-40 lg:sticky lg:h-screen lg:top-0">
				<div class="flex flex-col h-full">
					<div class="p-6 flex items-center justify-between border-b border-black/5 dark:border-white/5">
						<a href={base} class="flex items-center gap-2 font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-cyan-500 to-purple-500 sidebar-brand">
							<svg class="w-6 h-6 text-cyan-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
							<span>Snoopiest</span>
						</a>
						<button id="sidebar-collapse" class="hidden lg:block p-1.5 rounded-md hover:bg-black/5 dark:hover:bg-white/10 text-slate-400">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
						</button>
					</div>

					<nav class="flex-1 overflow-y-auto p-4 space-y-4">
						{SIDEBAR.map(item => (
							item.header ? (
								<h3 class="sidebar-header text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mt-6 mb-2 px-3">{item.text}</h3>
							) : (
								<a href={base.replace(/\/$/, '') + '/' + item.link.replace(/^\//, '')} class:list={[
									"flex items-center gap-3 py-2.5 px-3 rounded-xl transition-all duration-200 group",
									currentPath === item.link.replace(/\/$/, "") 
										? "bg-cyan-500/10 text-cyan-600 dark:text-cyan-400 font-semibold shadow-sm border border-cyan-500/20" 
										: "text-slate-500 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-black/5 dark:hover:bg-white/5"
								]}>
									<span class="sidebar-icon w-5 h-5 flex items-center justify-center text-slate-400 group-hover:text-cyan-500">
										{item.text === "Introduction" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>}
										{item.text === "Context Rot" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>}
										{item.text === "System Architecture" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>}
										{item.text === "Narrative Compression" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>}
										{item.text === "Chunking Strategy" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>}
										{item.text === "Context Engine" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>}
										{item.text === "Character Consistency" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>}
										{item.text === "Workflows" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>}
										{item.text === "Agentic Workflow" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>}
										{item.text === "Roadmap" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>}
										{item.text === "Tech Stack Flow" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>}
										{item.text === "Stack Implementation" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2" ry="2" stroke-width="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2" stroke-width="2"></rect><line x1="6" y1="6" x2="6" y2="6" stroke-width="3" stroke-linecap="round"></line><line x1="6" y1="18" x2="6" y2="18" stroke-width="3" stroke-linecap="round"></line></svg>}
										{item.text === "Cost Estimator" && <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>}
									</span>
									<span class="sidebar-text truncate">{item.text}</span>
								</a>
							)
						))}
					</nav>

					<div class="p-4 border-t border-black/5 dark:border-white/5 hidden lg:block">
						<button id="theme-toggle" class="flex items-center gap-3 w-full p-2.5 rounded-xl transition-all duration-200 hover:bg-black/5 dark:hover:bg-white/5 text-slate-500 hover:text-slate-900 dark:hover:text-slate-100">
							<div class="relative w-5 h-5">
								<svg class="absolute inset-0 dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4.243 1.757a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-1.757 4.243a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.243-1.757a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm1.757-4.243a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 5a5 5 0 100 10 5 5 0 000-10z"></path></svg>
								<svg class="absolute inset-0 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
							</div>
							<span class="sidebar-text">Switch Appearance</span>
						</button>
					</div>
				</div>
			</aside>

			<!-- Mobile Overlay -->
			<div id="overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden lg:hidden"></div>

			<!-- Main Content -->
			<main class="flex-1 min-w-0 p-6 lg:p-12">
				<div class="max-w-4xl mx-auto">
					{frontmatter?.hero && (
						<div class="mb-16">
							<h1 class="text-5xl lg:text-7xl font-extrabold tracking-tight mb-6 bg-clip-text text-transparent bg-gradient-to-br from-slate-900 to-slate-500 dark:from-white dark:to-slate-400">
								{frontmatter.title}
							</h1>
							<p class="text-xl text-slate-500 dark:text-slate-400 leading-relaxed max-w-3xl">
								{frontmatter.description}
							</p>
							<div class="h-px bg-gradient-to-r from-cyan-500/50 to-transparent w-full mt-12"></div>
						</div>
					)}
					
					<article class="prose dark:prose-invert">
						<slot />
					</article>

					<!-- Pagination -->
					<div class="mt-16 pt-8 border-t border-black/5 dark:border-white/5 flex flex-col sm:flex-row gap-4 justify-between">
						{prev ? (
							<a href={base.replace(/\/$/, '') + '/' + prev.link.replace(/^\//, '')} class="group flex flex-col gap-1 p-4 rounded-xl border border-black/5 dark:border-white/10 hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all text-left">
								<span class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-cyan-500">Previous</span>
								<span class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-cyan-600 dark:group-hover:text-cyan-400">
									← {prev.text}
								</span>
							</a>
						) : <div />}
						
						{next && (
							<a href={base.replace(/\/$/, '') + '/' + next.link.replace(/^\//, '')} class="group flex flex-col gap-1 p-4 rounded-xl border border-black/5 dark:border-white/10 hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all text-right items-end">
								<span class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-cyan-500">Next</span>
								<span class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-cyan-600 dark:group-hover:text-cyan-400">
									{next.text} →
								</span>
							</a>
						)}
					</div>
				</div>
			</main>
		</div>

		<script is:inline>
			const menuToggle = document.getElementById('menu-toggle');
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('overlay');
			const sidebarCollapse = document.getElementById('sidebar-collapse');
			const themeToggle = document.getElementById('theme-toggle');
			const themeToggleMobile = document.getElementById('theme-toggle-mobile');

			// Mobile Menu
			menuToggle?.addEventListener('click', () => {
				sidebar?.classList.remove('-translate-x-full');
				overlay?.classList.remove('hidden');
			});

			overlay?.addEventListener('click', () => {
				sidebar?.classList.add('-translate-x-full');
				overlay?.classList.add('hidden');
			});

			// Sidebar Collapse (Desktop)
			sidebarCollapse?.addEventListener('click', () => {
				const isCollapsed = sidebar.classList.contains('w-20');
				if (isCollapsed) {
					sidebar.classList.remove('w-20');
					sidebar.classList.add('w-72');
					sidebar.querySelectorAll('.sidebar-text').forEach(el => el.classList.remove('hidden'));
					sidebar.querySelectorAll('.sidebar-header').forEach(el => el.classList.remove('hidden'));
					sidebar.querySelector('.sidebar-brand span').classList.remove('hidden');
					sidebarCollapse.querySelector('svg').classList.remove('rotate-180');
				} else {
					sidebar.classList.remove('w-72');
					sidebar.classList.add('w-20');
					sidebar.querySelectorAll('.sidebar-text').forEach(el => el.classList.add('hidden'));
					sidebar.querySelectorAll('.sidebar-header').forEach(el => el.classList.add('hidden'));
					sidebar.querySelector('.sidebar-brand span').classList.add('hidden');
					sidebarCollapse.querySelector('svg').classList.add('rotate-180');
				}
			});

			// Theme Toggle
			const handleThemeToggle = () => {
				const element = document.documentElement;
				element.classList.toggle("dark");
				const isDark = element.classList.contains("dark");
				localStorage.setItem("theme", isDark ? "dark" : "light");
			}

			themeToggle?.addEventListener('click', handleThemeToggle);
			themeToggleMobile?.addEventListener('click', handleThemeToggle);
		</script>

		<style is:global>
			#sidebar.w-20 .sidebar-text,
			#sidebar.w-20 .sidebar-header,
			#sidebar.w-20 .sidebar-brand span {
				display: none;
			}
			#sidebar.w-20 .p-6 {
				justify-content: center;
			}
			#sidebar.w-20 nav {
				align-items: center;
			}
			#sidebar.w-20 nav a {
				justify-content: center;
				padding-left: 0;
				padding-right: 0;
				width: 44px;
				margin-left: auto;
				margin-right: auto;
			}
			#sidebar.w-20 .sidebar-brand {
				justify-content: center;
			}
			#sidebar.w-20 #sidebar-collapse {
				display: none; /* Just simple for now, maybe toggle on hover? */
			}
			/* Show collapse always for simplicity but fix position */
			#sidebar.w-20 .border-b {
				padding: 1.5rem 0.5rem;
			}
		</style>
	</body>
</html>
